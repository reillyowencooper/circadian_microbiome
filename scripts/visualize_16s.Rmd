---
title: "visualize_16s"
author: "Reilly Cooper"
date: "9/30/2020"
output: html_document
---

```{r setup, include=FALSE}
library(here)
library(speedyseq)
library(ggpubr)
library(tidyverse)
library(cowplot)
library(rstatix)
library(vegan)
library(stringi)
library(DivNet)
library(parallel)
library(microbiome)

theme_set(theme_cowplot(font_size = 12))

phylum_colors <- c("Actinobacteriota" = "#B62A3D",
                   "Bacteroidota" = "#A35E60",
                   "Deinococcota" = "#456355",
                   "Dependentiae" = "#27223C",
                   "Desulfobacterota" = "#CC8B3C",
                   "Firmicutes" = "#EDCB64",
                   "Firmicutes_A" = "#EDCB65",
                   "Firmicutes_C" = "#EDCB66",
                   "Patescibacteria" = "#55506A",
                   "Planctomycetota" = "#6C6781",
                   "Proteobacteria" = "#003f5c",
                   "Verrucomicrobiota" = "#E6A2C5",
                   "Myxococcota" = "#2f4b7c",
                   "<=1% Abundant/Unidentified" = "#C4CFD0")

family_colors <- c("<=5% Abundant/Unidentified" = "#C4CFD0",
                   "Burkholderiaceae" = "#27223C",
                   "Chitinophagaceae" = "#A35E60",
                   "Flavobacteriaceae" = "#7496D2",
                   "Nanopelagicaceae" = "#55506A",
                   "Spirosomaceae" = "#E6A2C5",
                   "Vicingaceae" = "#76A08A")

id_colors <- c("day_dentifera" = "#76A08A",
               "night_dentifera" = "#27223C",
               "day_magna" = "#E6A2C5",
               "night_magna" = "#A35E60")

species_colors <- c("dentifera" = "#76A08A",
                    "magna" = "#E6A2C5")

```

Load data and remove Cyanobacteria reads, add clarity to Sample variable and add ID variable
```{r dataload}
data <- readRDS(here("data", "processed_16s_all.rds")) %>% 
  subset_taxa(Phylum != "Cyanobacteria")

data@sam_data$id <- c(rep("day_magna", 10), rep("night_magna", 10),
                                  rep("night_dentifera", 9), rep("day_dentifera", 10))

data@sam_data$Sample <- str_replace_all(data@sam_data$Sample, "Plate", "")

data@sam_data$Sample <- str_replace_all(data@sam_data$Sample , 
                                 c("13A01" = "DM_D1","13A02" = "DM_D2","13A03" = "DM_D3",
                                   "13A04" = "DM_D4","13A05" = "DM_D5","13A06" = "DM_D6",
                                   "13A07" = "DM_D7","13A08" = "DM_D8","13A09" = "DM_D9",
                                   "13A10" = "DM_D10","13B01" = "DM_N1","13B02" = "DM_N2",
                                   "13B03" = "DM_N3","13B04" = "DM_N4","13B05" = "DM_N5",
                                   "13B06" = "DM_N6","13B07" = "DM_N7","13B08" = "DM_N8",
                                   "13B09" = "DM_N9","13B10" = "DM_N10","13D01" = "DD_D1",
                                   "13D02" = "DD_D2","13D03" = "DD_D3","13D04" = "DD_D4",
                                   "13D05" = "DD_D5","13D06" = "DD_D6","13D07" = "DD_D7",
                                   "13D08" = "DD_D8","13D09" = "DD_D9","13D10" = "DD_D10",
                                   "13C01" = "DD_N1","13C02" = "DD_N2","13C03" = "DD_N3",
                                   "13C04" = "DD_N4","13C05" = "DD_N5","13C06" = "DD_N6",
                                   "13C07" = "DD_N7","13C08" = "DD_N8","13C09" = "DD_N9"))
```

Creating a melted dataframe of the data, and reducing low abundance reads for clarity.
```{r melt}
data_transformed <- transform_sample_counts(data, function(x) x/sum(x))

melted <- psmelt(data_transformed) %>%
  select(-Sample) 

colnames(melted)[colnames(melted) == "sample_Sample"] <- "Sample"

no_low_abundance <- melted
no_low_abundance$Phylum[no_low_abundance$Abundance <= 0.01] <- "<=1% Abundant/Unidentified"
no_low_abundance$Phylum[is.na(no_low_abundance$Phylum)] <- "<=1% Abundant/Unidentified"
no_low_abundance$Family[no_low_abundance$Abundance <= 0.05] <- "<=5% Abundant/Unidentified"
no_low_abundance$Family[is.na(no_low_abundance$Family)] <- "<=5% Abundant/Unidentified"
```

Just looking at composition
```{r composition}
ggplot(no_low_abundance, aes(Sample, Abundance, fill = Phylum)) + 
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ species*time, scales = "free") +
  scale_fill_manual(values = phylum_colors) +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.95, vjust = 1),
        strip.background = element_blank()) +
  xlab("Sample") +
  ylab("Relative abundance")

ggplot(no_low_abundance, aes(Sample, Abundance, fill = Family)) + 
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ species*time, scales = "free") +
  scale_fill_manual(values = family_colors) +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.95, vjust = 1),
        strip.background = element_blank()) +
  xlab("Sample") +
  ylab("Relative abundance")

spp <- no_low_abundance %>%
  filter(!is.na(Genus) & Abundance > 0.001)
ggplot(spp, aes(Sample, Abundance, fill = Genus)) + 
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ species*time, scales = "free") +
  #scale_fill_manual(values = family_colors) +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.95, vjust = 1),
        strip.background = element_blank()) +
  xlab("Sample") +
  ylab("Relative abundance")
```

Summarizing the consensus microbiota composition of each species at each time point.
```{r consensus_composition}
data_by_type <- merge_samples2(data, group = "id")

dbtt <- transform_sample_counts(data_by_type, function(x) x/sum(x))

type_melted <- psmelt(dbtt) %>%
  select(-Sample, replicate, X)

colnames(type_melted)[colnames(type_melted) == "sample_Sample"] <- "Sample"

type_melted$Phylum[type_melted$Abundance <= 0.01] <- "<=1% Abundant/Unidentified"
type_melted$Phylum[is.na(type_melted$Phylum)] <- "<=1% Abundant/Unidentified"
type_melted$Family[type_melted$Abundance <= 0.05] <- "<=5% Abundant/Unidentified"
type_melted$Family[is.na(type_melted$Family)] <- "<=5% Abundant/Unidentified"

ggplot(type_melted, aes(id, Abundance, fill = Family)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = family_colors) +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.95, vjust = 1),
        strip.background = element_blank()) +
  xlab("Sample") +
  ylab("Relative abundance")

type_melted %>%
  filter(Abundance > 0.0001) %>%
  filter(!is.na(Genus)) %>%
  ggplot(aes(id, Abundance, fill = Genus)) +
  geom_bar(stat = "identity", position = "stack") +
  #scale_fill_manual(values = family_colors) +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.95, vjust = 1),
        strip.background = element_blank()) +
  xlab("Sample") +
  ylab("Relative abundance")
```

Checking alpha diversity using DivNet instead of standard phyloseq alpha diversity measures. DivNet provides more accurate measures of diversity by accounting for unobserved taxa and random sampling from a larger community.
```{r divnet_alphadiv}
dv_data <- divnet(data, ncores = 4)
data@sam_data

dv_data$shannon %>%
  summary %>%
  add_column("Sample" = data %>% sample_data %>% get_variable("Sample"))
  
dv_data$simpson %>%
  summary %>%
  add_column("Sample" = data %>% sample_data %>% get_variable("Sample"))

data_shannon <- dv_data$shannon %>% summary %>% select(sample_names, estimate) %>%
  mutate(id = data@sam_data$id) %>%
  mutate(species = data@sam_data$species) %>%
  mutate(time = data@sam_data$time)
data_simpson <- dv_data$simpson %>% summary %>% select(sample_names, estimate) %>%
  mutate(id = data@sam_data$id) %>%
  mutate(species = data@sam_data$species) %>%
  mutate(time = data@sam_data$time)

data_shannon$id <- factor(data_shannon$id, 
                          levels = c("day_dentifera", 
                                     "night_dentifera", 
                                     "day_magna", 
                                     "night_magna"))

data_simpson$id <- factor(data_shannon$id, 
                          levels = c("day_dentifera", 
                                     "night_dentifera", 
                                     "day_magna", 
                                     "night_magna"))

shannon_plot <- ggplot(data_shannon, aes(id, estimate, group = id, color = id)) + 
  geom_violin(lwd = 1) + 
  geom_jitter(height = 0, width = 0.05, alpha = 0.5, size = 2) +
  scale_color_manual(values = id_colors) +
  ylab("Shannon Index Estimate") +
  theme(axis.title.x = element_blank(),
        legend.position = "none") +
  scale_x_discrete(labels = c("D. dentifera, \n day",
                             "D. dentifera, \n night",
                             "D. magna, \n day",
                             "D. magna, \n night")) +
  stat_compare_means(method = "anova", label.y = 1.55)

simpson_plot <- ggplot(data_simpson, aes(id, 1/estimate, group = id, color = id)) + 
  geom_violin(lwd = 1) + 
  geom_jitter(height = 0, width = 0.05, alpha = 0.5, size = 2) +
  scale_color_manual(values = id_colors) +
  ylab("Inverse Simspon Index Estimate") +
  theme(axis.title.x = element_blank(),
        legend.position = "none") +
  scale_x_discrete(labels = c("D. dentifera, \n day",
                             "D. dentifera, \n night",
                             "D. magna, \n day",
                             "D. magna, \n night")) +
  stat_compare_means(method = "anova", label.y = 5)

plot_grid(shannon_plot, simpson_plot, nrow = 1)
```

Differences between species, regardless of day or night. This is a four panel figure:
a) Alpha diversity measures
b) Genus-level composition
d) Beta diversity measure, weighted UniFrac PCoA
```{r mag_v_dent}
species_comp_data <- merge_samples2(data, group = "species")

scdt <- transform_sample_counts(species_comp_data, function(x) x/sum(x))

species_melted <- psmelt(scdt) %>%
  select(-Sample, replicate, X)

colnames(species_melted)[colnames(species_melted) == "sample_Sample"] <- "Sample"

species_melted$Phylum[species_melted$Abundance <= 0.01] <- "<=1% Abundant/Unidentified"
species_melted$Phylum[is.na(species_melted$Phylum)] <- "<=1% Abundant/Unidentified"
species_melted$Family[species_melted$Abundance <= 0.05] <- "<=5% Abundant/Unidentified"
species_melted$Family[is.na(species_melted$Family)] <- "<=5% Abundant/Unidentified"
species_melted$Genus[species_melted$Abundance <= 0.01] <- "<=1% Abundant/Unidentified"
species_melted$Genus[is.na(species_melted$Genus)] <- "<=1% Abundant/Unidentified"

species_melted$species <- factor(species_melted$species, levels = c("magna", "dentifera"))
data_simpson$species <- factor(data_simpson$species, levels = c("magna", "dentifera"))
genus_colors <- c("<=1% Abundant/Unidentified" = "#C4CFD0",
                  "Acidovorax_D" = "#A35E60",
                  "Arcticibacterium" = "#456355",
                  "BRH-c54" = "#76A08A",
                  "Emticicia" = "#CC8B3C",
                  "Flavobacterium" = "#7496D2",
                  "Fluviicola" = "#55506A",
                  "Hydromonas" = "#6C6781",
                  "Hylemonella" = "#003f5c",
                  "Lacibacter" = "#E6A2C5",
                  "Limnobacter" = "#2f4b7c",
                  "Limnohabitans" = "#27223C",
                  "Nevskia" = "#EDCB64",
                  "Planktophila" = "#541F12",
                  "Polynucleobacter" = "#E8D2B9",
                  "Vitreoscilla_A" = "#AEA8A8")


species_composition_plot <- ggplot(species_melted, aes(species, Abundance, fill = Genus)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = genus_colors) +
  theme(axis.title.x = element_blank()) +
  ylab("Relative abundance") +
  scale_x_discrete(labels = c("Daphnia\nmagna",
                              "Daphnia\ndentifera"))

species_alphadiv_plot <- ggplot(data_simpson, aes(species, 1/estimate, group = species, color = species)) + 
  geom_violin(lwd = 1, width = .5) + 
  geom_jitter(height = 0, width = 0.05, alpha = 0.5, size = 2) +
  scale_color_manual(values = species_colors) +
  ylab("Inverse Simpson Index Estimate") +
  theme(axis.title.x = element_blank(),
        legend.position = "none") +
  scale_x_discrete(labels = c("Daphnia\nmagna",
                              "Daphnia\ndentifera")) +
  stat_compare_means(method = "t.test", label.y = 15, label.x = 0.75, label = "p.format")


wuniord <- ordinate(data, "PCoA", "unifrac", weighted = TRUE)
data.rel <- microbiome::transform(data, "compositional")
data.otu <- microbiome::abundances(data.rel)
data.meta <- microbiome::meta(data.rel)
data.unifrac <- UniFrac(data.rel,
                        weighted = TRUE,
                        normalized = TRUE,
                        parallel = FALSE,
                        fast = TRUE)
data.permanova <- adonis(data.unifrac ~ species, data = data.meta)

label <- paste("~italic(R)^2==~", round(data.permanova$aov.tab$R2[1], digits = 3))
p <- paste("~italic(P)==~", round(data.permanova$aov.tab$`Pr(>F)`[1], digits = 3))


w_ord_plot <- plot_ordination(data, wuniord, color = "species") +
  geom_point(size = 2) +
  scale_color_manual(values = species_colors) +
  stat_ellipse(linetype = 2) +
  annotate("text", x = 0, y = -0.075, label = label, parse = TRUE, size = 3.5) +
  annotate("text", x = 0, y = -0.085, label = p, parse = TRUE, size = 3.5)

w_ord_plot

figure_one <- plot_grid(plot_grid(species_alphadiv_plot, 
                                  species_composition_plot, 
                                  nrow = 1, 
                                  labels = c("a", "b"),
                                  rel_widths = c(0.5, .75), align = "h"),
                        plot_grid(NULL, 
                                  w_ord_plot, 
                                  NULL, 
                                  nrow = 1, 
                                  rel_widths = c(.25, .5, .25), 
                                  labels = c("", "c", "")), 
                        nrow = 2, 
                        align = "hv")

ggsave(here("figures", "figure_one.pdf"), 
       figure_one, 
       units = "in", 
       width = 8, 
       height = 8, 
       dpi = 300, 
       useDingbats = FALSE)
```

