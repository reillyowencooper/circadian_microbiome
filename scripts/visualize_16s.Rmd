---
title: "visualize_16s"
author: "Reilly Cooper"
date: "9/30/2020"
output: html_document
---

```{r setup, include=FALSE}
library(here)
library(speedyseq)
library(ggpubr)
library(tidyverse)
library(cowplot)
library(rstatix)
library(vegan)
library(stringi)
library(DivNet)
library(parallel)
library(microbiome)
library(gt)

theme_set(theme_cowplot(font_size = 12))

phylum_colors <- c("Actinobacteriota" = "#B62A3D",
                   "Bacteroidota" = "#A35E60",
                   "Deinococcota" = "#456355",
                   "Dependentiae" = "#27223C",
                   "Desulfobacterota" = "#CC8B3C",
                   "Firmicutes" = "#EDCB64",
                   "Firmicutes_A" = "#EDCB65",
                   "Firmicutes_C" = "#EDCB66",
                   "Patescibacteria" = "#55506A",
                   "Planctomycetota" = "#6C6781",
                   "Proteobacteria" = "#003f5c",
                   "Verrucomicrobiota" = "#E6A2C5",
                   "Myxococcota" = "#2f4b7c",
                   "<=1% Abundant/Unidentified" = "#C4CFD0")

family_colors <- c("<=5% Abundant/Unidentified" = "#C4CFD0",
                   "Burkholderiaceae" = "#27223C",
                   "Chitinophagaceae" = "#A35E60",
                   "Flavobacteriaceae" = "#7496D2",
                   "Nanopelagicaceae" = "#55506A",
                   "Spirosomaceae" = "#E6A2C5",
                   "Vicingaceae" = "#76A08A")

genus_colors <- c("<=1% Abundant/Unidentified" = "#C4CFD0",
                  "Acidovorax_D" = "#A35E60",
                  "Arcticibacterium" = "#456355",
                  "BRH-c54" = "#76A08A",
                  "Emticicia" = "#CC8B3C",
                  "Flavobacterium" = "#7496D2",
                  "Fluviicola" = "#55506A",
                  "Hydromonas" = "#6C6781",
                  "Hylemonella" = "#003f5c",
                  "Lacibacter" = "#E6A2C5",
                  "Limnobacter" = "#2f4b7c",
                  "Limnohabitans" = "#27223C",
                  "Methylophilus" = "#a1cacc",
                  "Methylotenera" = "#364362",
                  "Nevskia" = "#EDCB64",
                  "OLB11" = "#115189",
                  "Planktophila" = "#541F12",
                  "Polynucleobacter" = "#E8D2B9",
                  "Vitreoscilla_A" = "#AEA8A8")

id_colors <- c("day_dentifera" = "#76A08A",
               "night_dentifera" = "#27223C",
               "day_magna" = "#E6A2C5",
               "night_magna" = "#A35E60")

species_colors <- c("dentifera" = "#76A08A",
                    "magna" = "#E6A2C5")
```

Load data and remove Cyanobacteria reads, add clarity to Sample variable and add ID variable
```{r dataload}
data <- readRDS(here("data", "processed_16s_all.rds")) %>% 
  subset_taxa(Phylum != "Cyanobacteria")

data@sam_data$id <- c(rep("day_magna", 10), rep("night_magna", 10),
                                  rep("night_dentifera", 9), rep("day_dentifera", 10))

data@sam_data$Sample <- str_replace_all(data@sam_data$Sample, "Plate", "")

data@sam_data$Sample <- str_replace_all(data@sam_data$Sample , 
                                 c("13A01" = "DM_D1","13A02" = "DM_D2","13A03" = "DM_D3",
                                   "13A04" = "DM_D4","13A05" = "DM_D5","13A06" = "DM_D6",
                                   "13A07" = "DM_D7","13A08" = "DM_D8","13A09" = "DM_D9",
                                   "13A10" = "DM_D10","13B01" = "DM_N1","13B02" = "DM_N2",
                                   "13B03" = "DM_N3","13B04" = "DM_N4","13B05" = "DM_N5",
                                   "13B06" = "DM_N6","13B07" = "DM_N7","13B08" = "DM_N8",
                                   "13B09" = "DM_N9","13B10" = "DM_N10","13D01" = "DD_D1",
                                   "13D02" = "DD_D2","13D03" = "DD_D3","13D04" = "DD_D4",
                                   "13D05" = "DD_D5","13D06" = "DD_D6","13D07" = "DD_D7",
                                   "13D08" = "DD_D8","13D09" = "DD_D9","13D10" = "DD_D10",
                                   "13C01" = "DD_N1","13C02" = "DD_N2","13C03" = "DD_N3",
                                   "13C04" = "DD_N4","13C05" = "DD_N5","13C06" = "DD_N6",
                                   "13C07" = "DD_N7","13C08" = "DD_N8","13C09" = "DD_N9"))
```

Creating a melted dataframe of the data, and reducing low abundance reads for clarity.
```{r melt}
data_transformed <- transform_sample_counts(data, function(x) x/sum(x))

melted <- psmelt(data_transformed) %>%
  select(-Sample) 

colnames(melted)[colnames(melted) == "sample_Sample"] <- "Sample"

no_low_abundance <- melted
no_low_abundance$Phylum[no_low_abundance$Abundance <= 0.01] <- "<=1% Abundant/Unidentified"
no_low_abundance$Phylum[is.na(no_low_abundance$Phylum)] <- "<=1% Abundant/Unidentified"
no_low_abundance$Family[no_low_abundance$Abundance <= 0.05] <- "<=5% Abundant/Unidentified"
no_low_abundance$Family[is.na(no_low_abundance$Family)] <- "<=5% Abundant/Unidentified"
```

Checking alpha diversity using DivNet instead of standard phyloseq alpha diversity measures. DivNet provides more accurate measures of diversity by accounting for unobserved taxa and random sampling from a larger community.
```{r divnet_alphadiv}
dv_data <- divnet(data, ncores = 4)
data@sam_data

dv_data$shannon %>%
  summary %>%
  add_column("Sample" = data %>% sample_data %>% get_variable("Sample"))
  
dv_data$simpson %>%
  summary %>%
  add_column("Sample" = data %>% sample_data %>% get_variable("Sample"))

data_shannon <- dv_data$shannon %>% summary %>% select(sample_names, estimate) %>%
  mutate(id = data@sam_data$id) %>%
  mutate(species = data@sam_data$species) %>%
  mutate(time = data@sam_data$time)
data_simpson <- dv_data$simpson %>% summary %>% select(sample_names, estimate) %>%
  mutate(id = data@sam_data$id) %>%
  mutate(species = data@sam_data$species) %>%
  mutate(time = data@sam_data$time)

data_shannon$id <- factor(data_shannon$id, 
                          levels = c("day_dentifera", 
                                     "night_dentifera", 
                                     "day_magna", 
                                     "night_magna"))

data_simpson$id <- factor(data_shannon$id, 
                          levels = c("day_dentifera", 
                                     "night_dentifera", 
                                     "day_magna", 
                                     "night_magna"))

```

Figure 1.
Differences between species, regardless of day or night. This is a three panel figure:
a) Alpha diversity measures
b) Genus-level composition
d) Beta diversity measure, weighted UniFrac PCoA
```{r mag_v_dent}
species_comp_data <- merge_samples2(data, group = "species")

scdt <- transform_sample_counts(species_comp_data, function(x) x/sum(x))

species_melted <- psmelt(scdt) %>%
  select(-Sample, replicate, X)

colnames(species_melted)[colnames(species_melted) == "sample_Sample"] <- "Sample"

species_melted$Phylum[species_melted$Abundance <= 0.01] <- "<=1% Abundant/Unidentified"
species_melted$Phylum[is.na(species_melted$Phylum)] <- "<=1% Abundant/Unidentified"
species_melted$Family[species_melted$Abundance <= 0.05] <- "<=5% Abundant/Unidentified"
species_melted$Family[is.na(species_melted$Family)] <- "<=5% Abundant/Unidentified"
species_melted$Genus[species_melted$Abundance <= 0.01] <- "<=1% Abundant/Unidentified"
species_melted$Genus[is.na(species_melted$Genus)] <- "<=1% Abundant/Unidentified"

species_melted$species <- factor(species_melted$species, levels = c("magna", "dentifera"))
data_simpson$species <- factor(data_simpson$species, levels = c("magna", "dentifera"))

species_alphadiv_plot <- ggplot(data_simpson, aes(species, 1/estimate, group = species, color = species)) + 
  geom_violin(lwd = 1, width = .5) + 
  geom_jitter(height = 0, width = 0.05, alpha = 0.5, size = 2) +
  scale_color_manual(values = species_colors) +
  ylab("Inverse Simpson Index Estimate") +
  theme(axis.title.x = element_blank(),
        legend.position = "none") +
  scale_x_discrete(labels = c("Daphnia\nmagna",
                              "Daphnia\ndentifera")) +
  stat_compare_means(method = "t.test", label.y = 15, label.x = 0.75, label = "p.format")

species_composition_plot <- ggplot(species_melted, aes(species, Abundance, fill = Genus)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = genus_colors) +
  theme(axis.title.x = element_blank()) +
  ylab("Relative abundance") +
  scale_x_discrete(labels = c("Daphnia\nmagna",
                              "Daphnia\ndentifera"))

wuniord <- ordinate(data, "PCoA", "unifrac", weighted = TRUE)
data.rel <- microbiome::transform(data, "compositional")
data.otu <- microbiome::abundances(data.rel)
data.meta <- microbiome::meta(data.rel)
data.unifrac <- UniFrac(data.rel,
                        weighted = TRUE,
                        normalized = TRUE,
                        parallel = FALSE,
                        fast = TRUE)
data.permanova <- adonis(data.unifrac ~ species, data = data.meta)

label <- paste("~italic(R)^2==~", round(data.permanova$aov.tab$R2[1], digits = 3))
p <- paste("~italic(P)==~", round(data.permanova$aov.tab$`Pr(>F)`[1], digits = 3))

w_ord_plot <- plot_ordination(data, wuniord, color = "species") +
  geom_point(size = 2) +
  scale_color_manual(values = species_colors) +
  stat_ellipse(linetype = 2) +
  annotate("text", x = 0, y = -0.075, label = label, parse = TRUE, size = 3.5) +
  annotate("text", x = 0, y = -0.085, label = p, parse = TRUE, size = 3.5)


figure_one <- plot_grid(plot_grid(species_alphadiv_plot, 
                                  species_composition_plot, 
                                  nrow = 1, 
                                  labels = c("a", "b"),
                                  rel_widths = c(0.5, .75), align = "h"),
                        plot_grid(NULL, 
                                  w_ord_plot, 
                                  NULL, 
                                  nrow = 1, 
                                  rel_widths = c(.25, .5, .25), 
                                  labels = c("", "c", "")), 
                        nrow = 2, 
                        align = "hv")

ggsave(here("figures", "figure_one.pdf"), 
       figure_one, 
       units = "in", 
       width = 8, 
       height = 8, 
       dpi = 300, 
       useDingbats = FALSE)
```

Day vs. night differences in both Daphnia species. 
```{r day_night, warning=FALSE}
data_by_sp_time <- data
transformed_sp_time <- transform_sample_counts(data_by_sp_time, function(x) x/sum(x))

sp_time_melted <- psmelt(transformed_sp_time) %>%
  select(-c(replicate, X))



sp_time_melted$Phylum[sp_time_melted$Abundance <= 0.01] <- "<=1% Abundant/Unidentified"
sp_time_melted$Phylum[is.na(sp_time_melted$Phylum)] <- "<=1% Abundant/Unidentified"
sp_time_melted$Family[sp_time_melted$Abundance <= 0.05] <- "<=5% Abundant/Unidentified"
sp_time_melted$Family[is.na(sp_time_melted$Family)] <- "<=5% Abundant/Unidentified"
sp_time_melted$Genus[sp_time_melted$Abundance <= 0.01] <- "<=1% Abundant/Unidentified"
sp_time_melted$Genus[is.na(sp_time_melted$Genus)] <- "<=1% Abundant/Unidentified"

# Alpha diversity
data_simpson$id <- factor(data_simpson$id, 
                          levels = c("day_magna", 
                                     "night_magna", 
                                     "day_dentifera", 
                                     "night_dentifera"))
comparisons <- list(c("day_magna", "night_magna"), 
                    c("day_dentifera", "night_dentifera"))

time_alphadiv_plot <- ggplot(data_simpson, aes(id, 1/estimate, group = id, color = id)) + 
  geom_violin() +
  geom_jitter(height = 0, width = 0.05, alpha = 0.5, size = 2) +
  scale_color_manual(values = id_colors) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(size = 8),
        legend.position = "none") +
  scale_x_discrete(labels = c("Daphnia\nmagna,\nday",
                              "Daphnia\nmagna,\nnight",
                              "Daphnia\ndentifera,\nday",
                              "Daphnia\ndentifera,\nnight")) +
  stat_compare_means(comparisons = comparisons, label.y = c(19, 19), size = 4) +
  stat_compare_means(method = "anova", label.y = 15) +
  ylab("Inverse Simpson Index Estimate")

# Composition, genus level
sp_time_melted %>% mutate(identifier = ifelse(time == "day" & species == "magna", "Daphnia\nmagna,\nday", 
                                              ifelse(time == "day" & species == "dentifera", "Daphnia\ndentifera,\nday", 
                                                     ifelse(time == "night" & species == "magna", "Daphnia\nmagna,\nnight", "Daphnia\ndentifera,\nnight")))) -> sp_time_melted

sp_time_melted$identifier <- factor(sp_time_melted$identifier, levels = c("Daphnia\nmagna,\nday", "Daphnia\nmagna,\nnight",
                                                                          "Daphnia\ndentifera,\nday", "Daphnia\ndentifera,\nnight"))
time_composition_plot <- ggplot(sp_time_melted, aes(Sample, Abundance, fill = Genus)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = genus_colors) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        strip.background = element_blank(),
        strip.placement = "outside", 
        strip.text.x = element_text(size = 8)) +
  ylab("Relative abundance") +
  facet_wrap(~identifier, scales = "free_x", ncol = 4, strip.position = "bottom")

figure_two <- plot_grid(time_alphadiv_plot, 
                    time_composition_plot, 
                    nrow = 1, rel_widths = c(0.5, 1),
                    align = "hv", labels = "auto")

ggsave(here("figures", "figure_two.pdf"), 
       figure_two, 
       units = "in", 
       width = 8, 
       height = 4, 
       dpi = 300, 
       useDingbats = FALSE)

# Will fix "Genus" and Anova value overlap in Illustrator
```

Figure 3: Genera of interest
```{r}
# Specific genera
sp_time_melted <- melted
colnames(sp_time_melted)[colnames(sp_time_melted) == "sample_Sample"] <- "Sample"
sp_time_melted$Family[sp_time_melted$Abundance <= 0.01] <- "<=1% Abundant/Unidentified"
sp_time_melted$Family[is.na(sp_time_melted$Family)] <- "<=1% Abundant/Unidentified"
sp_time_melted$Genus[sp_time_melted$Abundance <= 0.01] <- "<=1% Abundant/Unidentified"
sp_time_melted$Genus[is.na(sp_time_melted$Genus)] <- "<=1% Abundant/Unidentified"
sp_time_melted$id <- factor(sp_time_melted$id, 
                            levels = c("day_magna", 
                                       "night_magna", 
                                       "day_dentifera", 
                                       "night_dentifera"))
genus <- c("Emticicia", "Fluviicola", "Hydromonas", "Limnohabitans", "Polynucleobacter", "Articibacterium", "Planktophila")

genus_abundance_plot <- sp_time_melted %>% 
  filter(Genus %in% genus) %>%
  ggplot(aes(id, Abundance, color = id)) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(position = position_jitterdodge(), alpha = 0.5) +
  scale_color_manual(values = id_colors, 
                     labels = c("Daphnia magna,\nday",
                                "Daphnia magna,\nnight",
                                "Daphnia dentifera,\nday",
                                "Daphnia dentifera,\nnight"),
                     name = "") +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.background = element_blank(),
        strip.text.x = element_text(size = 8)) +
  ylab("Genus Relative Abundance") +
  facet_wrap(~ Genus, scales = "free", nrow = 2)

ggsave(here("figures", "figure_three.pdf"), 
       genus_abundance_plot, 
       units = "in", 
       width = 6, 
       height = 6, 
       dpi = 300, 
       useDingbats = FALSE)
```


Identifying core microbiota between host species.
```{r core, warning=FALSE}
magna <- subset_samples(data, species == "magna")
dentifera <- subset_samples(data, species == "dentifera")

magna_rel <- microbiome::transform(magna, "compositional")
dentifera_rel <- microbiome::transform(dentifera, "compositional")

magna_nolow <- prune_taxa(taxa_sums(magna_rel) > 0, magna_rel)
dentifera_nolow <- prune_taxa(taxa_sums(dentifera_rel) > 0, dentifera_rel)

magna_core <- core(magna_nolow, detection = 0.001, prevalence = 50/100)
dentifera_core <- core(dentifera_nolow, detection = 0.001, prevalence = 50/100)

magna_core_df <- as.data.frame(magna_core@tax_table) %>% rownames_to_column("ASV")
dentifera_core_df <- as.data.frame(dentifera_core@tax_table) %>% rownames_to_column("ASV")

in_both <- merge(magna_core_df, dentifera_core_df) %>% mutate(core = "Both")
magna_only <- anti_join(magna_core_df, dentifera_core_df) %>% mutate(core = "Daphnia magna")
dentifera_only <- anti_join(dentifera_core_df, magna_core_df) %>% mutate(core = "Daphnia dentifera")

core_table <- do.call("rbind", list(in_both, magna_only, dentifera_only))

# Getting mean relative abundance of each ASV in core
asvs <- core_table$ASV

find_asv_df <- melted
colnames(find_asv_df)[1] <- "ASV"
core_filt <- filter(find_asv_df, ASV %in% asvs)

core_magna_abundance <- core_filt %>% filter(species == "magna") %>%
  group_by(ASV) %>%
  summarise(magna_abundance = mean(Abundance))
core_dentifera_abundance <- core_filt %>% filter(species == "dentifera") %>%
  group_by(ASV) %>%
  summarise(dentifera_abundance = mean(Abundance))

core_table <- merge(core_table, core_magna_abundance, all = TRUE) %>% merge(core_dentifera_abundance, all = TRUE)

core_table$core <- factor(core_table$core, levels = c("Both", "Daphnia magna", "Daphnia dentifera"))
# Actual ASVs go in supplemental table, for clarity

core_table_ordered <- core_table %>%
  mutate(core = fct_relevel(core, c("Both", "Daphnia magna", "Daphnia dentifera"))) %>%
  arrange(core, desc(magna_abundance), desc(dentifera_abundance)) %>%
  relocate(ASV, .after = dentifera_abundance) %>%
  relocate(c(core, magna_abundance, dentifera_abundance), .before = Kingdom) %>%
  mutate_if(is.numeric, round, 3) %>%
  select(-c(Kingdom, ASV)) %>%
  gt() %>%
  cols_label(magna_abundance = md("Mean relative abundance in\n_Daphnia magna_"),
             dentifera_abundance = md("Mean relative abundance in\n_Daphnia dentifera_"),
             core = "Core to:") %>%
  data_color(columns = vars(core),
             colors = scales::col_factor(palette = c("#27223C", "#76A08A", "#E6A2C5"),
                                         domain = c("Both", "Daphnia dentifera", "Daphnia magna")),
             alpha = 0.5) %>%
  data_color(columns = vars(magna_abundance),
             colors = scales::col_numeric(palette = c("#469990", "#93E6DD"),
                                          domain = c(0, 0.512)),
             alpha = 0.5) %>%
  data_color(columns = vars(dentifera_abundance),
             colors = scales::col_numeric(palette = c("#469990", "#93E6DD"),
                                          domain = c(0, 0.154)),
             alpha = 0.5) %>%
  tab_spanner(label = "Taxonomic identity",
              columns = vars(Class, Order, Family, Genus, Species)) %>%
  cols_align(align = "left") %>%
  tab_options(heading.align = "left",
              column_labels.border.bottom.width = px(2),
              column_labels.border.bottom.color = "black",
              table.border.bottom.color = "black",
              table.border.bottom.width = px(2))

gtsave(core_table_ordered, here("figures", "table_one.pdf"))

```


